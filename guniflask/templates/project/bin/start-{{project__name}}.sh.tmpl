#!/usr/bin/env bash

bin=$(dirname ${BASH_SOURCE[0]})
bin=$(cd "$bin"; pwd)

. "$bin"/{{project__name}}-config.sh

if [ ! -d "$GUNIFLASK_APP_LOG_DIR" ]; then
    mkdir -p "$GUNIFLASK_APP_LOG_DIR"
fi
if [ ! -d "$GUNIFLASK_APP_PID_DIR" ]; then
    mkdir -p "$GUNIFLASK_APP_PID_DIR"
fi

gconf="$GUNIFLASK_APP_CONF_DIR"/startup.py

echo "start {{project_name}}"

cd "$GUNIFLASK_APP_HOME"
gunicorn -c "$gconf" "{{project_name}}.app:create_app()" $@
cd - > /dev/null

sleep 3
target_pid=$("$PYTHON" "$bin"/catpid.py "$gconf")
if ! ps -p $target_pid > /dev/null 2>&1; then
    echo "fail to start {{project_name}}"
    exit 1
else
    echo "{{project_name}} started"
fi
