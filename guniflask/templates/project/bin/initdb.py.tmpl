# coding=utf-8

import sys
import os
import argparse

_home_dir = os.environ['GUNIFLASK_HOME']
if _home_dir not in sys.path:
    sys.path.append(_home_dir)

from {{project_name}}.app import create_app
from {{project_name}} import db
from {{project_name}}.utils.config import walk_modules

import logging

log = logging.getLogger(__name__)


def init_db(argv=None):
    if argv is None:
        argv = sys.argv
    parser = argparse.ArgumentParser()
    parser.usage = '[options]'
    parser.description = 'initialize database'
    parser.add_argument('-f', dest='force', action='store_true', default=False,
                        help='force creating all tables')
    args = parser.parse_args(args=argv[1:])
    walk_modules('{{project_name}}.models')
    app = create_app()
    with app.app_context():
        if args.force:
            db.drop_all()
        else:
            print("\033[33;40mThe tables already exist will be skipped.\033[0m")
            print("\033[33;40mYou can try '-f' option to force creating all tables.\033[0m")
        db.create_all()


if __name__ == '__main__':
    init_db()
