#!/usr/bin/env bash

bin=$$(dirname $0)
bin=$$(cd "$bin"; pwd)

. "$$bin"/${project-name}-config.sh

if [ ! -d "$$${PORJECT_NAME}_LOG_DIR" ]; then
    mkdir -p "$$${PORJECT_NAME}_LOG_DIR"
fi
if [ ! -d "$$${PORJECT_NAME}_PID_DIR" ]; then
    mkdir -p "$$${PORJECT_NAME}_PID_DIR"
fi

gconf="$$${PORJECT_NAME}_CONF_DIR"/gunicorn.py

echo "start ${project_name}"

cd "$$${PORJECT_NAME}_HOME"
gunicorn -c "$$gconf" -D "${project_name}.app:create_app()" $$@
cd - > /dev/null

sleep 3
target_pid=$$("$$PYTHON" "$bin"/cat_pid.py "$$gconf")
if ! ps -p $$target_pid > /dev/null 2>&1; then
    echo "fail to start ${project_name}"
    exit 1
else
    echo "${project_name} started"
fi